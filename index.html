<!DOCTYPE html>
<html lang="pt">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Home Control</title>
    <style>
        :root { --p: #2563eb; --s: #10b981; --warn: #f59e0b; --danger: #ef4444; --bg: #f1f5f9; --card: #ffffff; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: 'Segoe UI', system-ui, sans-serif; }
        body { background: var(--bg); margin: 0; padding: 0; color: #1e293b; padding-bottom: 90px; }

        /* Login Screen Full Overlay */
        #login-screen {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--bg); z-index: 9999;
            display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .login-card {
            background: white; padding: 30px; border-radius: 24px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1); width: 100%; max-width: 350px; text-align: center;
        }

        .status-header { 
            font-size: 0.75rem; padding: 10px; text-align: center;
            background: white; border-bottom: 1px solid #e2e8f0;
            font-weight: bold; position: sticky; top: 0; z-index: 100;
        }

        .container { width: 100%; max-width: 500px; margin: auto; padding: 15px; }
        .page { display: none; }
        .page.active { display: block; }

        .card { background: var(--card); padding: 20px; border-radius: 24px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); margin-bottom: 20px; }
        h2 { font-size: 1.2rem; margin: 0 0 20px 0; color: var(--p); display: flex; justify-content: space-between; align-items: center; }

        .nav-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; display: flex; justify-content: space-around;
            padding: 10px; border-top: 1px solid #e2e8f0; z-index: 1000;
        }
        .nav-item {
            border: none; background: none; font-size: 0.7rem; font-weight: bold;
            color: #94a3b8; display: flex; flex-direction: column; align-items: center; gap: 4px;
        }
        .nav-item.active { color: var(--p); }

        input { background: #f8fafc; border: 2px solid #e2e8f0; border-radius: 12px; padding: 12px; font-size: 16px; width: 100%; outline: none; margin-bottom: 10px; }
        
        .low-stock { border-color: var(--warn) !important; background: #fffbeb !important; }
        .out-of-stock { border-color: var(--danger) !important; background: #fef2f2 !important; }

        .btn { border: none; border-radius: 14px; font-weight: 700; cursor: pointer; display: flex; align-items: center; justify-content: center; min-height: 48px; width: 100%; }
        .btn-add { background: var(--s); color: white; margin-top: 10px; }
        .btn-del { background: #fee2e2; color: var(--danger); padding: 0 12px; border-radius: 10px; border: none; height: 40px; }
        .btn-logout { background: #f1f5f9; color: #64748b; font-size: 0.65rem; border: none; padding: 6px 10px; border-radius: 8px; cursor: pointer; font-weight: bold; }

        .stock-row, .todo-row { display: flex; gap: 8px; margin-bottom: 12px; align-items: center; }
        .todo-check { width: 28px; height: 28px; accent-color: var(--s); cursor: pointer; }
        .todo-done { text-decoration: line-through; opacity: 0.5; }
        .dia-label { font-size: 0.7rem; font-weight: 800; color: #94a3b8; text-transform: uppercase; margin-bottom: 4px; display: block; }
        .sugestao-card { background: #eff6ff; border: 1px solid #bfdbfe; padding: 15px; border-radius: 16px; margin-bottom: 15px; }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <div style="font-size: 3rem; margin-bottom: 10px;">üè†</div>
            <h2 style="justify-content: center;">Home Control</h2>
            <div id="login-msg" style="color: var(--danger); font-size: 0.8rem; margin-bottom: 10px; display: none;">Acesso negado</div>
            <input type="text" id="user" placeholder="Utilizador" spellcheck="false">
            <input type="password" id="pass" placeholder="Palavra-passe">
            <button class="btn btn-add" onclick="verificarLogin()" style="background: var(--p)">Entrar</button>
        </div>
    </div>

    <div class="status-header" id="status-api">‚òÅÔ∏è A ligar...</div>

    <div class="container">
        <div id="page-todos" class="page active">
            <div class="card">
                <h2>‚úÖ Afazeres <button class="btn-logout" onclick="logout()">Sair</button></h2>
                <div id="lista-todo"></div>
                <button class="btn btn-add" onclick="addTodo()">+ Nova Tarefa</button>
            </div>
        </div>

        <div id="page-stock" class="page">
            <div class="card">
                <h2>üì¶ Despensa</h2>
                <div id="lista-stock"></div>
                <button class="btn btn-add" style="background:#64748b" onclick="addItem()">+ Novo Item</button>
            </div>
        </div>

        <div id="page-ementa" class="page">
            <div class="card">
                <h2>üìÖ Ementa</h2>
                <div id="container-receitas"></div>
                <div id="lista-ementa"></div>
            </div>
        </div>
    </div>

    <nav class="nav-bar">
        <button class="nav-item active" onclick="showPage('page-todos', this)"><span>‚úÖ</span><span>Tarefas</span></button>
        <button class="nav-item" onclick="showPage('page-stock', this)"><span>üì¶</span><span>Stock</span></button>
        <button class="nav-item" onclick="showPage('page-ementa', this)"><span>üìÖ</span><span>Ementa</span></button>
    </nav>

<script>
    const BIN_ID = "698bd32aae596e708f212bfc"; 
    const API_KEY = "$2a$10$dyhhWbJxbYjcfGsu/BPA3ePp1sbZ5TalNywgdCTIGf7YkCrEnWld6"; 
    const URL = `https://api.jsonbin.io/v3/b/${BIN_ID}`;

    let stock = [], ementa = {}, todos = [], cloudAuth = null;
    let saveTimeout;
    const dias = ["Segunda", "Ter√ßa", "Quarta", "Quinta", "Sexta", "S√°bado", "Domingo"];
    
    // In√≠cio
    window.onload = async () => {
        const logado = sessionStorage.getItem("isLoggedIn");
        await carregarTudoDaNuvem(); // Baixa os dados primeiro (incluindo auth)
        
        if (logado === "true") {
            document.getElementById('login-screen').style.display = 'none';
            render();
        }
    };

    async function carregarTudoDaNuvem() {
        try {
            updateStatus("‚òÅÔ∏è A ligar...", "#f1f5f9");
            const res = await fetch(URL, { headers: { "X-Master-Key": API_KEY } });
            const data = await res.json();
            
            // Dados da Nuvem
            cloudAuth = data.record.auth;
            stock = data.record.stock || [];
            ementa = data.record.ementa || {};
            todos = data.record.todos || [];
            
            updateStatus("‚úÖ Ligado", "#dcfce7");
        } catch (err) { 
            updateStatus("‚ùå Erro de Rede", "#fee2e2"); 
        }
    }

    function verificarLogin() {
        const u = document.getElementById('user').value;
        const p = document.getElementById('pass').value;
        const msg = document.getElementById('login-msg');

        if (!cloudAuth) { alert("Aguarde a liga√ß√£o √† nuvem..."); return; }

        // Procura o par user/pass no array baixado do JSONBin
        const userOk = cloudAuth.find(a => a.user === u && a.pass === p);

        if (userOk) {
            sessionStorage.setItem("isLoggedIn", "true");
            document.getElementById('login-screen').style.display = 'none';
            render();
        } else {
            msg.style.display = 'block';
        }
    }

    function logout() {
        sessionStorage.clear();
        location.reload();
    }

    // NAVEGA√á√ÉO
    function showPage(pageId, btn) {
        if (sessionStorage.getItem("isLoggedIn") !== "true") return;
        salvarEmentaLocal(); 
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(pageId).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
    }

    function salvarEmentaLocal() {
        dias.forEach(d => {
            const el = document.getElementById(`in-${d}`);
            if (el) ementa[d] = el.value;
        });
    }

    // CLOUD SAVE
    function triggerAutoSave() {
        updateStatus("‚è≥ A guardar...", "#fef9c3");
        clearTimeout(saveTimeout);
        saveTimeout = setTimeout(salvarNaCloud, 2000); 
    }

    async function salvarNaCloud() {
        salvarEmentaLocal();
        try {
            await fetch(URL, {
                method: 'PUT',
                headers: { "Content-Type": "application/json", "X-Master-Key": API_KEY },
                body: JSON.stringify({ auth: cloudAuth, stock, ementa, todos })
            });
            updateStatus("‚úÖ Sincronizado", "#dcfce7");
        } catch (err) { updateStatus("‚ùå Erro ao Gravar", "#fee2e2"); }
    }

    function updateStatus(text, bg) {
        const s = document.getElementById('status-api');
        if(s) { s.innerText = text; s.style.background = bg; }
    }

    // RENDERS
    function render() {
        // Todos
        document.getElementById('lista-todo').innerHTML = todos.map((t, i) => `
            <div class="todo-row">
                <input type="checkbox" class="todo-check" ${t.done ? 'checked' : ''} onchange="todos[${i}].done=this.checked; triggerAutoSave(); render()">
                <input type="text" class="${t.done ? 'todo-done' : ''}" value="${t.txt}" onchange="todos[${i}].txt=this.value; triggerAutoSave()">
                <button class="btn-del" onclick="removerTodo(${i})">√ó</button>
            </div>`).join('');

        // Stock
        document.getElementById('lista-stock').innerHTML = stock.map((item, i) => {
            const cl = item.qtd <= 0 ? 'out-of-stock' : (item.qtd === 1 ? 'low-stock' : '');
            return `
            <div class="stock-row">
                <input type="text" style="flex:3" class="${cl}" value="${item.nome}" onchange="stock[${i}].nome=this.value; triggerAutoSave(); verificarReceitas()">
                <input type="number" style="flex:1" class="${cl}" value="${item.qtd}" onchange="stock[${i}].qtd=parseInt(this.value)||0; triggerAutoSave(); render()">
                <button class="btn-del" onclick="removerStock(${i})">√ó</button>
            </div>`;
        }).join('');

        // Ementa
        document.getElementById('lista-ementa').innerHTML = dias.map(dia => `
            <div style="margin-bottom:12px">
                <label class="dia-label">${dia}</label>
                <input type="text" id="in-${dia}" value="${ementa[dia] || ''}" onchange="triggerAutoSave()">
            </div>`).join('');

        verificarReceitas();
    }

    function verificarReceitas() {
        const RECEITAS = [
            { nome: "üç≥ Omelete", ing: ["ovo"] },
            { nome: "üçù Massa com Atum", ing: ["massa", "atum"] },
            { nome: "üçó Frango com Arroz", ing: ["frango", "arroz"] },
            { nome: "ü•ì Carbonara", ing: ["massa", "ovo", "bacon"] }
        ];
        const box = document.getElementById('container-receitas');
        const itens = stock.filter(i => i.qtd > 0).map(i => i.nome.toLowerCase());
        const sug = RECEITAS.filter(r => r.ing.every(ing => itens.some(meu => meu.includes(ing))));
        box.innerHTML = sug.length ? `<div class="sugestao-card"><span class="dia-label" style="color:var(--p)">Podes fazer:</span><b>${sug.map(s=>s.nome).join(" ‚Ä¢ ")}</b></div>` : "";
    }

    function addTodo() { todos.push({txt: "", done: false}); render(); }
    function removerTodo(i) { if(confirm("Eliminar?")) { todos.splice(i,1); render(); triggerAutoSave(); } }
    function addItem() { stock.push({nome: "", qtd: 1}); render(); }
    function removerStock(i) { if(confirm("Eliminar?")) { stock.splice(i,1); render(); triggerAutoSave(); } }

</script>
</body>
</html>
